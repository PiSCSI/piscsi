services:
  piscsi:
    container_name: piscsi
    image: piscsi:develop-${OS_DISTRO:-debian}-${OS_VERSION:-buster}-${OS_ARCH:-amd64}-standalone
    pull_policy: never
    build:
      context: ..
      dockerfile: docker/piscsi/Dockerfile
      args:
        - OS_DISTRO=${OS_DISTRO:-debian}
        - OS_VERSION=${OS_VERSION:-buster}
        - OS_ARCH=${OS_ARCH:-amd64}
    volumes:
      - ./volumes/images:/home/pi/images:delegated
      - ./volumes/config:/home/pi/.config/piscsi:delegated
    ports:
      - "127.0.0.1:${PISCSI_PORT:-6868}:6868"
    environment:
     - PISCSI_PASSWORD=${PISCSI_PASSWORD:-}
    init: true
    command: [
      "/usr/local/bin/piscsi_wrapper.sh",
      "-L",
      "${PISCSI_LOG_LEVEL:-trace}",
      "-r",
      "7",
      "-F",
      "/home/pi/images"
    ]

  piscsi_web:
    container_name: piscsi_web
    image: piscsi:develop-${OS_DISTRO:-debian}-${OS_VERSION:-buster}-${OS_ARCH:-amd64}-web
    pull_policy: never
    build:
      context: ..
      dockerfile: docker/piscsi-web/Dockerfile
      args:
        - OS_DISTRO=${OS_DISTRO:-debian}
        - OS_VERSION=${OS_VERSION:-buster}
        - OS_ARCH=${OS_ARCH:-amd64}
    volumes:
      - ./volumes/images:/home/pi/images:delegated
      - ./volumes/config:/home/pi/.config/piscsi:delegated
    ports:
      - "127.0.0.1:${WEB_HTTP_PORT:-8080}:80"
      - "127.0.0.1:${WEB_HTTPS_PORT:-8443}:443"
    environment:
     - PISCSI_PASSWORD=${PISCSI_PASSWORD:-}
    init: true
    command: [
      "start.sh",
      "--piscsi-host=${PISCSI_HOST:-piscsi}",
      "--piscsi-port=${PISCSI_PORT:-6868}",
      "--log-level=${WEB_LOG_LEVEL:-info}",
      "--dev-mode"
    ]

  pytest:
    container_name: pytest
    image: piscsi:pytest
    pull_policy: never
    profiles:
      - webui-tests
    build:
      context: ..
      dockerfile: docker/pytest/Dockerfile
    volumes:
      - ../python/web:/src:delegated
    working_dir: /src
    entrypoint: "pytest"
