services:
  backend:
    container_name: rascsi_backend
    image: rascsi-backend
    pull_policy: never
    build:
      context: ..
      dockerfile: docker/backend/Dockerfile
    volumes:
      - ./volumes/images:/home/pi/images:delegated
      - ./volumes/config:/home/pi/.config/rascsi:delegated
    ports:
      - "127.0.0.1:${RASCSI_PORT:-6868}:6868"
    environment:
     - RASCSI_PASSWORD=${RASCSI_PASSWORD:-}
    init: true
    command: [
      "-L",
      "${RASCSI_LOG_LEVEL:-trace}",
    ]

  web:
    container_name: rascsi_web
    image: rascsi-web:${OS_VERSION:-buster}
    pull_policy: never
    build:
      context: ..
      dockerfile: docker/web/Dockerfile
      args:
        - OS_VERSION=${OS_VERSION:-buster}
    volumes:
      - ./volumes/images:/home/pi/images:delegated
      - ./volumes/config:/home/pi/.config/rascsi:delegated
    ports:
      - "127.0.0.1:${WEB_HTTP_PORT:-8080}:80"
      - "127.0.0.1:${WEB_HTTPS_PORT:-8443}:443"
    environment:
     - RASCSI_PASSWORD=${RASCSI_PASSWORD:-}
    init: true
    command: [
      "--rascsi-host=${RASCSI_HOST:-backend}",
      "--rascsi-port=${RASCSI_PORT:-6868}",
      "--log-level=${WEB_LOG_LEVEL:-debug}",
      "--dev-mode"
    ]

  pytest:
    container_name: rascsi_pytest
    image: rascsi-pytest
    pull_policy: never
    profiles:
      - webui-tests
    build:
      context: ..
      dockerfile: docker/pytest/Dockerfile
    working_dir: /src
    command: ["-vv"]